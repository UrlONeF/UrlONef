<!DOCTYPE html>
<html lang="it">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Netflix AR Cover</title>
    
    <!-- Scripts: MindAR + A-Frame -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <link rel="stylesheet" href="index.css">
    <link rel="manifest" href="manifest.json">
  </head>
  <body>
    <!-- Login Overlay -->
    <div id="login-overlay">
      <h1>MEMORIES</h1>
      <p>Inserisci codice di accesso</p>
      <input type="password" id="password-input" placeholder="Codice Segreto">
      <button id="login-btn" class="netflix-btn">ACCEDI</button>
      <div id="login-msg" class="error-msg"></div>
    </div>

    <!-- Overlay UI (Initially hidden behind login) -->
    <div id="ui-layer" style="display:none">
      <div id="scan-overlay" class="hidden">
        <div class="scan-guide">
          <div class="corner top-left"></div>
          <div class="corner top-right"></div>
          <div class="corner bottom-left"></div>
          <div class="corner bottom-right"></div>
          <p>Inquadra la cornice</p>
        </div>
      </div>
      
      <div id="controls">
        <button id="start-btn" class="netflix-btn">INIZIA ESPERIENZA</button>
      </div>

      <div id="video-ui" class="hidden">
         <div class="netflix-logo">NETFLIX MEMORIES</div>
      </div>
    </div>

    <!-- AR Scene -->
    <a-scene 
      mindar-image="imageTargetSrc: ./assets/targets.mind; uiScanning: no;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <!-- Video Asset vuoto inizialmente, popolato via JS dopo decrittazione -->
        <video id="memories-video" crossorigin="anonymous" playsinline webkit-playsinline loop></video>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0">
        <a-video src="#memories-video" position="0 0 0" height="1.5" width="1" rotation="0 0 0"></a-video>
      </a-entity>
    </a-scene>

    <script>
      const sceneEl = document.querySelector('a-scene');
      const startBtn = document.getElementById('start-btn');
      const scanOverlay = document.getElementById('scan-overlay');
      const videoUi = document.getElementById('video-ui');
      const video = document.getElementById('memories-video');
      const uiLayer = document.getElementById('ui-layer');
      const loginOverlay = document.querySelector('#login-overlay');

      // --- DECRYPTION LOGIC ---
      async function decryptAndLoadVideo(password) {
          const msg = document.getElementById('login-msg');
          msg.textContent = "Verifica pass & download...";
          
          try {
              // Fetch Encrypted Blob
              const response = await fetch('./assets/video.enc');
              if (!response.ok) throw new Error("Video non trovato (assicurati di aver caricato video.enc)");
              const encryptedData = await response.arrayBuffer();

              // Extract Salt (16), IV (12)
              const salt = encryptedData.slice(0, 16);
              const iv = encryptedData.slice(16, 28);
              const data = encryptedData.slice(28);

              // Derive Key
              const enc = new TextEncoder();
              const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveKey"]);
              const key = await crypto.subtle.deriveKey(
                  { name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" },
                  keyMaterial,
                  { name: "AES-GCM", length: 256 },
                  false,
                  ["decrypt"]
              );

              // Decrypt
              const decryptedContent = await crypto.subtle.decrypt(
                  { name: "AES-GCM", iv: iv },
                  key,
                  data
              );

              // Set Video Source
              const blob = new Blob([decryptedContent], { type: 'video/mp4' });
              const url = URL.createObjectURL(blob);
              video.src = url;
              
              // Success: Show UI
              loginOverlay.style.display = 'none';
              uiLayer.style.display = 'flex';
              msg.textContent = "";

          } catch (e) {
              console.error(e);
              msg.textContent = "Password errata o file mancante!";
          }
      }

      document.getElementById('login-btn').addEventListener('click', () => {
          const pass = document.getElementById('password-input').value;
          if(pass) decryptAndLoadVideo(pass);
      });

      // --- EXISTING AR LOGIC ---

      // Gestione Start
      startBtn.addEventListener('click', () => {
        document.getElementById('controls').style.display = 'none';
        scanOverlay.classList.remove('hidden');
        sceneEl.play(); // Avvia AR engine
      });

      // Gestione Target Trovato/Perso
      const arSystem = sceneEl.systems["mindar-image-system"];
      const targetEntity = document.querySelector('[mindar-image-target]');

      targetEntity.addEventListener("targetFound", event => {
        console.log("Target found");
        scanOverlay.classList.add('hidden');
        videoUi.classList.remove('hidden');
        video.play();
        video.muted = false; 
      });

      targetEntity.addEventListener("targetLost", event => {
        console.log("Target lost");
        video.pause();
        scanOverlay.classList.remove('hidden');
        videoUi.classList.add('hidden');
      });
      
      // Fix per iOS audio policy
      document.body.addEventListener('click', () => {
         if(!video.paused) return;
         video.play().then(() => video.pause()); 
      }, {once: true});

      // PWA Service Worker Registration
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./service-worker.js')
            .then((reg) => console.log('Service Worker Registered'))
            .catch((err) => console.log('Service Worker Error', err));
        });
      }
    </script>
  </body>
</html>
